<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<style>
		body {
			width:100%;
			height:100%;
			margin:0;
		}
		html {
			width:100%;
			height:100%;
			margin:0;
		}
        #map {
            width: 100%;
            height: 100%;
            margin:0;
        }
        
		.SvgOverlay svg {
		    position: absolute;
		    top: -4000px;
		    left: -4000px;
		    width: 8000px;
		    height: 8000px;        
		}
        
        .SvgOverlay path {
            fill-opacity: .8;
        }
		
		.d3-tip {
  			line-height: 1;
  			font-weight: bold;
  			padding: 12px;
  			background: rgba(0, 0, 0, 0.8);
  			color: #fff;
  			border-radius: 2px;
			font-family: Arial, Helvetica, sans-serif;
			font-size: 12px;
		}
		
		.tip-item {
			padding: 2px 2px;
		}
		
		.d3-tip:after {
		  box-sizing: border-box;
		  display: inline;
		  font-size: 10px;
		  width: 100%;
		  line-height: 1;
		  color: rgba(0, 0, 0, 0.8);
		  content: "\25BC";
		  position: absolute;
		  text-align: center;
		}
		
		.d3-tip.n:after {
  			margin: -1px 0 0 0;
  			top: 100%;
  			left: 0;
		}
		
		.not_available {
			fill: rgb(219, 219, 219);
		}
		
		.extreme_value {
			fill: rgb(255, 81, 81);
		}
		
		svg:hover {
			fill: rgb(84, 84, 84);
		}

		
		
	</style>
    <link type="text/css" rel="stylesheet" href="colorbrewer.css" />
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script type="text/javascript"
  src="https://maps.googleapis.com/maps/api/js?libraries=visualization&sensor=false">
</script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
</head>
<body>
	<div id="map">


	</div>
	<script type="text/javascript">

		var width = '100%',
			height = '100%';
			fillColor = d3.rgb(215, 215, 250),
			strokeColor = d3.rgb(175, 175, 200);
		
		var projection = d3.geo.albers()
						.scale(1)
						.translate([0,0]);
								
		var path = d3.geo.path()
					.projection(projection);	
		
		
		d3.json("all_buildings_w_points_final.json", function(error, limits) {
			if (error) return console.error(error);
					
			//console.log(limits);

			makeMap(limits);
		});

	        function makeMap(borders) {
			
				var tip = d3.tip()
  					.attr('class', 'd3-tip')
  					.offset([-10, 0])
  					.html(function(d) {
    				return "<div class=\"tip-item\"> \
    							<strong>Property Name: </strong><span style='color:red'>" + d.properties.propertyName + "</span></strong> \
    						</div> \
    						<div class=\"tip-item\"> \
    							<strong>Address: </strong><span style='color:red'>" + d.properties.address + "</span></strong> \
    						</div> \
    						<div class=\"tip-item\"> \
    							<strong>Site EUI (kBtu / ft&#178): </strong><span style='color:red'>" + d.properties.siteEUIkBtuPerFt + "</span></strong> \
    						</div>";
  				});
				
				// Quantize for color brewer
				var pad = d3.format("05d");

				// Domain is range for EUI values that are expected to be blue
				var quantize = d3.scale.quantile().domain([0, 563]).range(d3.range(9));
			
	        	var allowedBounds = new google.maps.LatLngBounds(
					new google.maps.LatLng(39.91535, -75.26970), 
				    new google.maps.LatLng(39.98851, -75.06028)
				);

				var $map=$("#map");
				var map = new google.maps.Map($map[0], {
						zoom: 14,
						minZoom : 13,
						mapTypeId: google.maps.MapTypeId.ROADMAP,
						center: new google.maps.LatLng(39.95484,-75.16465), // Philadelphia
						styles:[{"stylers": [{"saturation": -75},{"lightness": 75}]}]					
					});

				var geoJson = borders;
				var overlay = new google.maps.OverlayView();

				fetchPlaces(borders);
				
				function fetchPlaces(buildings) {
				  buildings = buildings.features;
				  var heatmapData = [];
				  var maxWeight = 0;
		          for (building in buildings) {
		          	if (!isNaN(parseInt(buildings[building].properties.siteEUIkBtuPerFt)) && parseInt(Math.ceil(buildings[building].properties.siteEUIkBtuPerFt)) < 5000) {
		          		var thisWeight = parseInt(Math.ceil(buildings[building].properties.siteEUIkBtuPerFt));
		          		if (thisWeight > maxWeight) {
		          			maxWeight = thisWeight;
		          		}
		          	}
		          }
		          for (building in buildings) {
		          	var lng = buildings[building].properties.pointCoords[0];
		          	var lat = buildings[building].properties.pointCoords[1];

		            var latLng = new google.maps.LatLng(lat,lng);
		            if (!isNaN(parseInt(buildings[building].properties.siteEUIkBtuPerFt)) && parseInt(Math.ceil(buildings[building].properties.siteEUIkBtuPerFt)) < 5000) {
		            	var weight = parseInt(Math.ceil(buildings[building].properties.siteEUIkBtuPerFt));
		            	var weightedLocation = {};
		            	weightedLocation.location = latLng;
		            	weightedLocation.weight = weight/(maxWeight);
		            	heatmapData.push(weightedLocation);

		            	if (weight < 1) {
		            		console.log("Building: "+buildings[building].properties.propertyName);
		            		console.log(parseInt(Math.ceil(buildings[building].properties.siteEUIkBtuPerFt)));
		            	}
		            }
		          }
				  var heatmap = new google.maps.visualization.HeatmapLayer({
			     	data:heatmapData,
			     	dissipating:true,
			     	radius:75
				  });
				  console.log("Max Weight is: "+maxWeight)
				  heatmap.setMap(map);
			    };//End of Fetch Places


				overlay.onAdd = function () {

					var layer = d3.select(this.getPanes().overlayMouseTarget).append("div").attr("class", "SvgOverlay");
					var svg = layer.append("svg")
						.attr("width", $map.width())
						.attr("height", $map.height())
						.classed("Blues", true); // Set parent element's class for color brewer Blues
						
					svg.call(tip); // Set the tooltip
					
					var bounds = svg.append("g").attr("class", "bounds");

					overlay.draw = function () {
						var markerOverlay = this;
						var overlayProjection = markerOverlay.getProjection();

						// Turn the overlay projection into a d3 projection
						var googleMapProjection = function (coordinates) {
							var googleCoordinates = new google.maps.LatLng(coordinates[1], coordinates[0]);
							var pixelCoordinates = overlayProjection.fromLatLngToDivPixel(googleCoordinates);
							return [pixelCoordinates.x + 4000, pixelCoordinates.y + 4000];
						}
						
						
						// Draw the polygons

						path = d3.geo.path().projection(googleMapProjection);
						bounds.selectAll("path")
							.data(geoJson.features) // Load the feature collection
							.attr("d", path) // Update existing paths
						.enter().append("svg:path")
							.attr("d", path)
							.attr("class", function(d) {  
								if (d.properties.siteEUIkBtuPerFt == "Not Available") {
									return "not_available";
								} else if (parseInt(d.properties.siteEUIkBtuPerFt) > 2000) {
									return "extreme_value";
								} else {
									return "q" + quantize(d.properties.siteEUIkBtuPerFt) + "-9"; 
								}
							}) // If EUI is undefined the building will be gray, if EUI is greater than 2000 the building will be red, otherwise the building will be a shade of blue
							.on("click", clicked)
							.style("stroke", strokeColor)
							.on("mouseover", onMouseOver)
							.on("mouseout", onMouseOut)
					};
					
					function onMouseOver() {
						
						// Show tooltip on mouseover
						tip.show(d3.event.toElement.__data__, d3.event.toElement);
						//console.log(d3.event);
				
					}
					
					function onMouseOut() {

						// Hide tooltip on mouseout
						tip.hide(d3.event.toElement.__data__, d3.event.toElement);
					}

				};  // End of overlay.onAdd

				var lastValidCenter = map.getCenter();
	
				google.maps.event.addListener(map, 'center_changed', function() {
					if (allowedBounds.contains(map.getCenter())) {
						// Still within valid bounds, so save the last valid position
						lastValidCenter = map.getCenter();
						return; 
					}

					// Not valid anymore => return to last valid position
					map.panTo(lastValidCenter);
				});
				
				overlay.setMap(map);
			} // End of makeMap
			
			
		
			function clicked(d) {
				console.log((this).__data__);
				
				// Add this building to the object that will be used to build the scatter plot
			}
	</script>
</body>